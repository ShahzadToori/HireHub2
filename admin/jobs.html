<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Jobs – HireHub Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body class="admin-body">

<!-- Sidebar -->
<aside class="admin-sidebar" id="sidebar">
  <div class="sidebar-header">
    <span class="sidebar-brand">⚡ HireHub</span>
    <button class="btn-sidebar-close d-lg-none" id="sidebarClose"><i class="bi bi-x-lg"></i></button>
  </div>
  <nav class="sidebar-nav">
    <a href="dashboard.html"    class="sidebar-link"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
    <a href="jobs.html"         class="sidebar-link active"><i class="bi bi-briefcase"></i><span>All Jobs</span></a>
    <a href="add-job.html"      class="sidebar-link"><i class="bi bi-plus-circle"></i><span>Add Job</span></a>
    <a href="categories.html"   class="sidebar-link"><i class="bi bi-tag"></i><span>Categories</span></a>
    <a href="messages.html"     class="sidebar-link"><i class="bi bi-envelope"></i><span>Messages</span></a>
    <a href="monetization.html" class="sidebar-link"><i class="bi bi-currency-dollar"></i><span>Monetization</span></a>
    <a href="settings.html"     class="sidebar-link"><i class="bi bi-gear"></i><span>Settings</span></a>
    <a href="form-builder.html" class="sidebar-link"><i class="bi bi-ui-checks-grid"></i><span>Form Builder</span></a>
    <hr class="sidebar-divider">
    <a href="/" class="sidebar-link" target="_blank"><i class="bi bi-box-arrow-up-right"></i><span>View Site</span></a>
    <button class="sidebar-link sidebar-btn" id="logoutBtn"><i class="bi bi-box-arrow-right"></i><span>Logout</span></button>
  </nav>
</aside>
<div class="sidebar-overlay d-lg-none d-none" id="sidebarOverlay"></div>

<div class="admin-main">
  <header class="admin-topbar">
    <button class="btn-hamburger d-lg-none" id="sidebarToggle"><i class="bi bi-list fs-4"></i></button>
    <h1 class="topbar-title">Manage Jobs</h1>
    <div class="topbar-right">
      <a href="add-job.html" class="btn btn-admin-primary btn-sm"><i class="bi bi-plus-lg me-1"></i>Add Job</a>
      <button class="btn-icon-admin" id="themeToggleAdmin" title="Toggle theme"><i class="bi bi-moon-fill" id="adminThemeIcon"></i></button>
    </div>
  </header>

  <main class="admin-content">

    <!-- Filters -->
    <div class="admin-card mb-4">
      <div class="p-3">
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" class="form-control-custom" id="filterQ" placeholder="Search jobs…">
          </div>
          <div class="col-md-3">
            <select class="form-control-custom" id="filterStatus">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="expired">Expired</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-control-custom" id="filterCat">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-admin-primary w-100" id="applyFilters">Filter</button>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div class="d-flex gap-2 mt-2 align-items-center" id="bulkBar" style="display:none!important">
          <span class="text-muted small"><span id="selectedCount">0</span> selected</span>
          <button class="btn btn-sm btn-danger" id="bulkDelete">
            <i class="bi bi-trash me-1"></i>Delete Selected
          </button>
        </div>
      </div>
    </div>

    <!-- Jobs Table -->
    <div class="admin-card">
      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th style="width:36px"><input type="checkbox" id="selectAll" class="form-check-input"></th>
              <th>Job</th>
              <th class="d-none d-md-table-cell">Category</th>
              <th class="d-none d-md-table-cell">Location</th>
              <th>Status</th>
              <th class="d-none d-sm-table-cell">Featured</th>
              <th class="d-none d-lg-table-cell">Views</th>
              <th class="d-none d-md-table-cell">Posted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="jobsTable">
            <tr><td colspan="9" class="text-center text-muted py-4">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center p-3 border-top" style="border-color:var(--border)!important">
        <span class="text-muted small" id="tableInfo">–</span>
        <nav><ul class="pagination pagination-sm mb-0" id="tablePagination"></ul></nav>
      </div>
    </div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/admin/js/admin.js"></script>
<script>
  let currentPage = 1;
  const selectedIds = new Set();

  document.addEventListener('DOMContentLoaded', async () => {
    await requireAuth();
    await loadCatFilter();
    loadJobs();
    bindEvents();
  });

  async function loadCatFilter() {
    try {
      const data = await adminApi.get('/api/admin/categories');
      const sel  = document.getElementById('filterCat');
      data.categories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.slug;
        opt.textContent = c.name;
        sel.appendChild(opt);
      });
    } catch {}
  }

  async function loadJobs(page = 1) {
    currentPage = page;
    const q      = document.getElementById('filterQ').value.trim();
    const status = document.getElementById('filterStatus').value;
    const cat    = document.getElementById('filterCat').value;
    const params = new URLSearchParams({ page, limit: 20 });
    if (q)      params.set('q',        q);
    if (status) params.set('status',   status);
    if (cat)    params.set('category', cat);

    const tbody = document.getElementById('jobsTable');
    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>';

    try {
      const data = await adminApi.get(`/api/admin/jobs?${params}`);
      document.getElementById('tableInfo').textContent =
        `Showing ${data.jobs.length} of ${data.total} jobs`;

      if (data.jobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">No jobs found</td></tr>';
        document.getElementById('tablePagination').innerHTML = '';
        return;
      }

      tbody.innerHTML = data.jobs.map(job => `
        <tr>
          <td><input type="checkbox" class="form-check-input job-check" value="${job.id}"></td>
          <td>
            <strong class="d-block">${escHtml(job.title)}</strong>
            <small class="text-muted">${escHtml(job.company)}</small>
          </td>
          <td class="d-none d-md-table-cell">${escHtml(job.category)}</td>
          <td class="d-none d-md-table-cell">${escHtml(job.location)}</td>
          <td><span class="status-badge status-${job.status}">${job.status}</span></td>
          <td class="d-none d-sm-table-cell">
            ${job.featured ? '<span class="status-badge status-featured">⭐ Yes</span>' : '<span class="text-muted small">–</span>'}
          </td>
          <td class="d-none d-lg-table-cell">${job.views || 0}</td>
          <td class="d-none d-md-table-cell">${timeAgo(job.created_at)}</td>
          <td>
            <div class="d-flex gap-1">
              <a href="edit-job.html?id=${job.id}" class="btn-action btn-action-edit" title="Edit"><i class="bi bi-pencil"></i></a>
              <button class="btn-action btn-action-del" onclick="deleteJob(${job.id}, this)" title="Delete"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>
      `).join('');

      buildPagination(data.page, data.pages);
      bindCheckboxes();
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-4">Failed to load jobs</td></tr>`;
    }
  }

  function buildPagination(cur, total) {
    const ul = document.getElementById('tablePagination');
    ul.innerHTML = '';
    if (total <= 1) return;

    for (let i = 1; i <= total; i++) {
      const li = document.createElement('li');
      li.className = `page-item${i === cur ? ' active' : ''}`;
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
      li.addEventListener('click', (e) => { e.preventDefault(); loadJobs(i); });
      ul.appendChild(li);
    }
  }

  function bindCheckboxes() {
    document.querySelectorAll('.job-check').forEach(cb => {
      cb.addEventListener('change', () => {
        if (cb.checked) selectedIds.add(Number(cb.value));
        else             selectedIds.delete(Number(cb.value));
        updateBulkBar();
      });
    });
  }

  function updateBulkBar() {
    const bar = document.getElementById('bulkBar');
    const cnt = document.getElementById('selectedCount');
    cnt.textContent = selectedIds.size;
    bar.style.display = selectedIds.size > 0 ? 'flex' : 'none';
  }

  function bindEvents() {
    document.getElementById('selectAll').addEventListener('change', (e) => {
      document.querySelectorAll('.job-check').forEach(cb => {
        cb.checked = e.target.checked;
        if (e.target.checked) selectedIds.add(Number(cb.value));
        else                   selectedIds.delete(Number(cb.value));
      });
      updateBulkBar();
    });

    document.getElementById('applyFilters').addEventListener('click', () => loadJobs(1));
    document.getElementById('filterQ').addEventListener('keypress', (e) => { if (e.key === 'Enter') loadJobs(1); });

    document.getElementById('bulkDelete').addEventListener('click', async () => {
      if (selectedIds.size === 0) return;
      if (!confirm(`Delete ${selectedIds.size} jobs?`)) return;
      try {
        await adminApi.del('/api/admin/jobs', { ids: [...selectedIds] });
        selectedIds.clear();
        updateBulkBar();
        loadJobs(currentPage);
      } catch { alert('Bulk delete failed'); }
    });
  }

  async function deleteJob(id, btn) {
    if (!confirm('Delete this job?')) return;
    try {
      await adminApi.del(`/api/admin/jobs/${id}`);
      btn.closest('tr').remove();
    } catch { alert('Delete failed'); }
  }
</script>
</body>
</html>
